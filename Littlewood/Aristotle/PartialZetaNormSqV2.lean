/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: fc00e994-7ae1-4431-a748-f6c4736ce0d0

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
-/

/-
We prove the norm-squared expansion for partial zeta sums.
The main result is `normSq_partialZeta_eq`, which states that the norm squared of the partial zeta sum
is equal to a double sum involving real powers and cosines.
This corresponds to the algebraic expansion of `|Σ (n+1)^(-s)|²`.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

namespace PartialZetaNormSqV2

/-
The norm squared of the partial zeta sum is equal to a double sum involving real powers and cosines.
This is the general form: |Σ_{n=1}^N n^{-s}|² = Σ_n Σ_m ((n)(m))^{-Re(s)} cos(Im(s) log(n/m))
-/
lemma normSq_partialZeta_general (N : ℕ) (s : ℂ) :
    Complex.normSq (∑ n ∈ Finset.range N, (n + 1 : ℂ)^(-s)) =
    ∑ n ∈ Finset.range N, ∑ m ∈ Finset.range N,
      ((n+1:ℝ) * (m+1:ℝ))^(-s.re) * Real.cos (s.im * Real.log ((n+1:ℝ)/(m+1:ℝ))) := by
        -- By definition of norm squared, we have $|z|^2 = z \cdot \overline{z}$ for any complex number $z$.
        have h_norm_sq : Complex.normSq (∑ n ∈ Finset.range N, ((n + 1 : ℂ) ^ (-s))) = (∑ n ∈ Finset.range N, ((n + 1 : ℂ) ^ (-s))) * (∑ n ∈ Finset.range N, ((n + 1 : ℂ) ^ (-(starRingEnd ℂ s)))) := by
          -- By definition of complex conjugate, we know that $\overline{z} = \sum_{n=0}^{N-1} \overline{(n+1)^{-s}}$.
          have h_conj : ∑ n ∈ Finset.range N, ((n + 1 : ℂ) ^ (-(starRingEnd ℂ s))) = starRingEnd ℂ (∑ n ∈ Finset.range N, ((n + 1 : ℂ) ^ (-s))) := by
            simp +decide [ Complex.ext_iff, Complex.exp_re, Complex.exp_im, Complex.log_re, Complex.log_im, Complex.cpow_def ];
            norm_cast ; norm_num [ Complex.exp_re, Complex.exp_im, Complex.log_re, Complex.log_im ];
          simp_all +decide [ Complex.normSq, Complex.mul_re, Complex.mul_im ];
          simp_all +decide [ Complex.ext_iff, Finset.sum_add_distrib ];
          ring;
        -- Now consider the expression $\sum_{n=0}^{N-1} \sum_{m=0}^{N-1} \left( \frac{n+1}{m+1} \right)^{-\sigma} e^{-i t \log \frac{n+1}{m+1}}$.
        have h_double_sum : Complex.normSq (∑ n ∈ Finset.range N, ((n + 1 : ℂ) ^ (-s))) = ∑ n ∈ Finset.range N, ∑ m ∈ Finset.range N, ((n + 1 : ℂ) ^ (-s)) * ((m + 1 : ℂ) ^ (-(starRingEnd ℂ s))) := by
          rw [ h_norm_sq, Finset.sum_mul ];
          simp +decide only [Finset.mul_sum _ _ _];
        convert congr_arg Complex.re h_double_sum using 1;
        norm_num [ Complex.exp_re, Complex.exp_im, Complex.log_re, Complex.log_im, Complex.cpow_def ];
        refine' Finset.sum_congr rfl fun i hi => Finset.sum_congr rfl fun j hj => _ ; norm_cast ; norm_num [ Complex.exp_re, Complex.exp_im, Complex.log_re, Complex.log_im, Real.rpow_def_of_pos, add_pos_of_nonneg_of_pos, Nat.cast_nonneg ] ; ring;
        field_simp;
        rw [ show ( 1 + i + i * j + j : ℝ ) = ( 1 + i ) * ( 1 + j ) by ring, Real.log_mul ( by positivity ) ( by positivity ) ] ; rw [ Real.log_div ( by positivity ) ( by positivity ) ] ; rw [ ← Real.exp_add ] ; ring;
        rw [ Real.cos_sub ] ; ring
end PartialZetaNormSqV2
