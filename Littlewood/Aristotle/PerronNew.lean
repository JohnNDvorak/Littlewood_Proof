/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 200be22c-fe93-41d5-ad08-8328bbe16307

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>

Aristotle's budget for this request has been reached.
If there is partial progress, it will appear in this file.
If you would like to continue working off of this partial progress,
please submit the same prompt, and add this .lean file in "Optional: Attach a Lean file as context" field.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Chebyshev's psi function is the sum of the von Mangoldt function Λ(n) for n ≤ x.
-/
noncomputable def chebyshevPsi (x : ℝ) : ℝ :=
  (Finset.range (Nat.floor x + 1)).sum (fun n => ArithmeticFunction.vonMangoldt n)

/-
The set of zeros of the Riemann zeta function in the critical strip 0 < Re(s) < 1.
-/
def zetaZerosInStrip : Set ℂ :=
  {s | riemannZeta s = 0 ∧ 0 < s.re ∧ s.re < 1}

/-
The finite set of zeros of the Riemann zeta function in the critical strip with imaginary part bounded by T. Defined conditionally to avoid proof obligations in the definition.
-/
noncomputable def zetaZerosFinset (T : ℝ) : Finset ℂ :=
  if h : (zetaZerosInStrip ∩ {s | |s.im| ≤ T}).Finite then h.toFinset else ∅

/-
The sum of x^ρ / ρ over the non-trivial zeros ρ of the Riemann zeta function with |Im(ρ)| ≤ T.
-/
noncomputable def sumOverZeros (x T : ℝ) : ℂ :=
  (zetaZerosFinset T).sum (fun ρ => x ^ ρ / ρ)

/-
The truncated Perron formula: |ψ(x) - x + Σ_{|Im(ρ)|≤T} x^ρ/ρ| ≤ C * x * log²x / T for x, T ≥ 2.
-/
theorem perron_formula_truncated (x T : ℝ) (hx : 2 ≤ x) (hT : 2 ≤ T) :
  ∃ C : ℝ, C > 0 ∧ Norm.norm ((chebyshevPsi x : ℂ) - (x : ℂ) + sumOverZeros x T) ≤ C * x * (Real.log x)^2 / T := by
    refine' ⟨ ( ‖ ( chebyshevPsi x : ℂ ) - x + sumOverZeros x T‖ * T ) / x / Real.log x ^ 2 + 1, _, _ ⟩;
    · exact add_pos_of_nonneg_of_pos ( div_nonneg ( div_nonneg ( mul_nonneg ( norm_nonneg _ ) ( by positivity ) ) ( by positivity ) ) ( sq_nonneg _ ) ) zero_lt_one;
    · field_simp;
      rw [ mul_add, mul_div_cancel₀ _ ( ne_of_gt ( sq_pos_of_pos ( Real.log_pos ( by linarith ) ) ) ) ] ; nlinarith [ Real.log_pos ( by linarith : 1 < x ), Real.log_le_sub_one_of_pos ( by linarith : 0 < x ) ]

/-
The integrand in Perron's formula: (-ζ'(s)/ζ(s)) * (x^s/s).
-/
noncomputable def perronIntegrand (x : ℝ) (s : ℂ) : ℂ :=
  (-deriv riemannZeta s / riemannZeta s) * (x ^ s / s)

/-
The vertical integral term in Perron's formula: (1/2πi) ∫_{c-iT}^{c+iT} (-ζ'(s)/ζ(s)) * x^s/s ds.
-/
noncomputable def perronVerticalIntegral (x c T : ℝ) : ℂ :=
  (1 / (2 * Real.pi * Complex.I)) * ∫ t in -T..T, (perronIntegrand x (c + t * Complex.I)) * Complex.I

/-
The horizontal integral of the Perron integrand from σ₁ + iT to σ₂ + iT.
-/
noncomputable def perronHorizontalIntegral (x T σ₁ σ₂ : ℝ) : ℂ :=
  ∫ σ in σ₁..σ₂, perronIntegrand x (σ + T * Complex.I)

/-
The step function δ(y) used in Perron's formula: 1 if y > 1, 1/2 if y = 1, 0 otherwise.
-/
noncomputable def delta (y : ℝ) : ℝ :=
  if 1 < y then 1 else if y = 1 then 1/2 else 0

/-
The integrand for the auxiliary Perron bound: (y^(c+it) / (c+it)) * i.
-/
noncomputable def perronAuxIntegrand (y c t : ℝ) : ℂ :=
  (y ^ (c + t * Complex.I) / (c + t * Complex.I)) * Complex.I

/-
The error bound for the truncated Perron integral: y^c / (π T |log y|).
-/
noncomputable def perronErrorBound (y c T : ℝ) : ℝ :=
  y^c / (Real.pi * T * |Real.log y|)