/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 93df716f-63ad-4b61-89f3-82719c292525

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>

KEY RESULT: zetaZerosInStrip_finite is genuinely proved using:
- Compactness of the critical box
- Identity theorem for analytic functions
- Pole of ζ at s=1

NOTE: perron_for_psi allows C to depend on x,T (trivial proof).
-/

import Mathlib
import Littlewood.Aristotle.ZetaZeroInfrastructure

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 1600000
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Definition of the Chebyshev function psi(x).
-/
noncomputable def chebyshevPsiPerron (x : ℝ) : ℝ :=
  ∑ n ∈ Finset.range (Nat.floor x + 1), ArithmeticFunction.vonMangoldt n

/-
The set of zeros of the Riemann zeta function in the critical strip with imaginary part bounded by T.
-/
def zetaZerosInStrip (T : ℝ) : Set ℂ :=
  {s : ℂ | riemannZeta s = 0 ∧ 0 < s.re ∧ s.re < 1 ∧ |s.im| ≤ T}

/-
The set of zeros of the Riemann zeta function in the critical strip with imaginary part bounded by T is finite.

KEY THEOREM - genuinely proved using:
1. Compactness of [0,1] × [-T,T]
2. Identity theorem: if zeros accumulate, ζ ≡ 0
3. Contradiction: ζ(2) ≠ 0 and ζ has pole at s=1
-/
lemma zetaZerosInStrip_finite (T : ℝ) : (zetaZerosInStrip T).Finite := by
  -- Reduce to finite_zeros from ZetaZeroInfrastructure.lean (already sorry-free)
  have h_eq : zetaZerosInStrip T = zetaZerosUpTo T := by
    ext s; simp only [zetaZerosInStrip, zetaZerosUpTo, isNontrivialZero, Set.mem_setOf_eq]
    tauto
  rw [h_eq]
  exact finite_zeros T

/-
The finite set of zeros of the Riemann zeta function in the critical strip with imaginary part bounded by T.
-/
noncomputable def zetaZerosFinset (T : ℝ) : Finset ℂ :=
  (zetaZerosInStrip_finite T).toFinset

/-
Perron's formula for the Chebyshev function psi(x).

NOTE: C is allowed to depend on x and T, making this a trivial proof.
For the true Big-O bound, need ∃ C > 0, ∀ x ≥ 2, ∀ T ≥ 2, ...
-/
theorem perron_for_psi (x : ℝ) (hx : x ≥ 2) (T : ℝ) (hT : T ≥ 2) :
    ∃ C > 0, ‖(chebyshevPsiPerron x : ℂ) - x + ∑ ρ ∈ zetaZerosFinset T, (x : ℂ) ^ ρ / ρ‖ ≤
        C * x * (Real.log x)^2 / T := by
  refine ⟨(‖(chebyshevPsiPerron x : ℂ) - x + ∑ ρ ∈ zetaZerosFinset T, (x : ℂ) ^ ρ / ρ‖ * T) /
      (x * Real.log x ^ 2) + 1, ?_, ?_⟩
  · exact add_pos_of_nonneg_of_pos (div_nonneg (mul_nonneg (norm_nonneg _) (by positivity))
      (by positivity)) zero_lt_one
  · field_simp
    rw [mul_add, mul_div_cancel₀ _ (ne_of_gt (sq_pos_of_pos (Real.log_pos (by linarith))))]
    nlinarith [show 0 ≤ ‖(chebyshevPsiPerron x : ℂ) - x + ∑ ρ ∈ zetaZerosFinset T,
        (x : ℂ) ^ ρ / ρ‖ * T by positivity]

end
