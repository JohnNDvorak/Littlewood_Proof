/-
This file was generated by Aristotle (https://aristotle.harmonic.fun).

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: c0857924-b24c-456c-b9e2-aede8913a30b

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>

Aristotle's budget for this request has been reached.
If there is partial progress, it will appear in this file.
If you would like to continue working off of this partial progress,
please submit the same prompt, and add this .lean file in "Optional: Attach a Lean file as context" field.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 3200000
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

namespace Aristotle.ZeroCountingV2
/-
The number of zeros of the Riemann zeta function in the critical strip with imaginary part between 0 and T.
-/
noncomputable def zetaZeroCount (T : ℝ) : ℕ :=
  (Set.ncard {s : ℂ | riemannZeta s = 0 ∧ 0 < s.re ∧ s.re < 1 ∧ 0 < s.im ∧ s.im ≤ T})

/-
The integral of the logarithmic derivative of the Riemann zeta function around the boundary of the rectangle [ε, 1-ε] x [0, T].
-/
noncomputable def zetaLogDerivIntegral (T : ℝ) (ε : ℝ) : ℂ :=
  let f := fun s => deriv riemannZeta s / riemannZeta s
  let bottom := ∫ x in ε..(1-ε), f (x + 0 * Complex.I)
  let right := ∫ y in 0..T, f ((1-ε) + y * Complex.I)
  let top := ∫ x in ε..(1-ε), f (x + T * Complex.I)
  let left := ∫ y in 0..T, f (ε + y * Complex.I)
  bottom + Complex.I • right - top - Complex.I • left

/-
The zeros of the Riemann zeta function are isolated away from the pole at s=1.
-/
lemma riemannZeta_zeros_isolated :
    ∀ s : ℂ, s ≠ 1 → riemannZeta s = 0 → ∃ ε > 0, ∀ z, z ≠ s → z ∈ Metric.ball s ε → riemannZeta z ≠ 0 := by
      intro s hs_ne_one hs_zero
      have h_analytic : AnalyticAt ℂ riemannZeta s := by
        apply_rules [ DifferentiableOn.analyticAt ];
        swap;
        exact IsOpen.mem_nhds isOpen_ne hs_ne_one;
        intro y hy; exact differentiableAt_riemannZeta ( by aesop ) |> DifferentiableAt.differentiableWithinAt;
      have := h_analytic.eventually_eq_zero_or_eventually_ne_zero;
      rcases this with h|h <;> simp_all +decide [ eventually_nhdsWithin_iff ];
      · -- If the zeta function is zero in a neighborhood of $s$, then it must be identically zero, contradicting the fact that it has a pole at $s=1$.
        have h_contradiction : ∀ z : ℂ, z ≠ 1 → riemannZeta z = 0 := by
          intro z hz_ne_one
          have h_eq_zero : AnalyticOnNhd ℂ riemannZeta {z : ℂ | z ≠ 1} := by
            apply_rules [ DifferentiableOn.analyticOnNhd ];
            · intro z hz_ne_one; exact (by
              refine' DifferentiableAt.differentiableWithinAt _;
              exact?);
            · exact isOpen_ne;
          apply h_eq_zero.eqOn_zero_of_preconnected_of_eventuallyEq_zero;
          rotate_right;
          exact s;
          · -- The set {z : | z ≠ 1} is path-connected, hence � pre�connected.
            have h_path_connected : IsPathConnected {z : ℂ | z ≠ 1} := by
              -- The set {z : | z ≠ 1} is path-connected because it � is� the complement of a single point in the complex plane.
              have h_path_connected : IsPathConnected (Set.univ \ {0} : Set ℂ) := by
                -- The set of nonzero complex numbers is path-connected because it is the continuous image of the path-connected space $\mathbb{R}^2 \setminus \{0\}$ under the continuous map $z \map �sto� e^z$.
                have h_exp_path_connected : IsPathConnected (Set.range (fun z : ℂ => Complex.exp z)) := by
                  exact isPathConnected_range Complex.continuous_exp;
                convert h_exp_path_connected using 1 ; ext ; simp +decide [ Complex.exp_ne_zero ];
              have h_path_connected : IsPathConnected (Set.image (fun z : ℂ => z + 1) (Set.univ \ {0})) := by
                apply_rules [ IsPathConnected.image, h_path_connected ];
                exact continuous_id.add continuous_const;
              convert h_path_connected using 1 ; ext ; aesop;
            exact h_path_connected.isConnected.isPreconnected;
          · exact?;
          · exact h;
          · assumption;
        exact absurd ( h_contradiction 2 ( by norm_num ) ) ( by norm_num [ riemannZeta_two ] );
      · exact Metric.mem_nhds_iff.mp h |> fun ⟨ ε, ε_pos, hε ⟩ => ⟨ ε, ε_pos, fun z hz₁ hz₂ => hε hz₂ hz₁ ⟩

/-
The Riemann zeta function is non-zero in a small punctured neighborhood of s=1.
-/
lemma riemannZeta_ne_zero_near_one :
    ∃ δ > 0, ∀ s : ℂ, s ≠ 1 → s ∈ Metric.ball 1 δ → riemannZeta s ≠ 0 := by
      -- Since $\zeta(s)$ has a simple pole at $s=1$, $|\zeta(s)| \to \infty$ as $s \to 1$. Thus, there is a neighborhood of 1 where $\zeta(s) \ne �q� 0$.
      have h_pole : ∀ᶠ s in nhdsWithin 1 {1}ᶜ, riemannZeta s ≠ 0 := by
        -- The Riemann zeta function has a simple pole at $ �s�=1$ with residue $1$, so for $s$ near $1$, $\zeta(s)$ is approximately $1/(s-1)$.
        have h_residue : Filter.Tendsto (fun s : ℂ => (s - 1) * riemannZeta s) (nhdsWithin 1 {1}ᶜ) (nhds 1) := by
          exact?;
        filter_upwards [ h_residue.eventually_ne one_ne_zero ] with s hs using by aesop;
      rcases Metric.mem_nhdsWithin_iff.mp h_pole with ⟨ δ, δ_pos, hδ ⟩ ; use δ ; aesop;

/-
The number of zeros of the Riemann zeta function in any compact set that does not contain the pole s=1 is finite.
-/
lemma zeta_zeros_finite_in_compact_avoiding_one (K : Set ℂ) (hK : IsCompact K) (h_avoid : 1 ∉ K) :
    Set.Finite {s ∈ K | riemannZeta s = 0} := by
      -- By contradiction, assume there are infinitely many zeros of the Riemann zeta function in $K$.
      by_contra h_inf_zeros
      have h_accum_point : ∃ z₀ ∈ K, riemannZeta z₀ = 0 ∧ ∀ ε > 0, ∃ z ∈ K, riemannZeta z = 0 ∧ z ≠ z₀ ∧ z ∈ Metric.ball z₀ ε := by
        by_contra h_no_accumulation_point;
        -- If there are no accumulation points of zeros in $K$, then the set of zeros in $K$ is discrete.
        have h_discrete : DiscreteTopology {s ∈ K | riemannZeta s = 0} := by
          refine' singletons_open_iff_discrete.mp _;
          intro s;
          rw [ Metric.isOpen_iff ];
          intro x hx;
          obtain ⟨ ε, hε_pos, hε ⟩ : ∃ ε > 0, ∀ z ∈ K, riemannZeta z = 0 → z ≠ x.val → ¬(z ∈ Metric.ball x.val ε) := by
            aesop;
          exact ⟨ ε, hε_pos, fun y hy => Subtype.ext <| Classical.not_not.1 fun hy' => hε y y.2.1 y.2.2 ( by aesop ) <| by simpa [ Subtype.ext_iff ] using hy ⟩;
        have h_finite : Set.Finite {s ∈ K | riemannZeta s = 0} := by
          have h_compact : IsCompact {s ∈ K | riemannZeta s = 0} := by
            have h_closed : IsClosed {s ∈ K | riemannZeta s = 0} := by
              have h_closed : ContinuousOn (fun s => riemannZeta s) K := by
                intro s hs;
                refine' ContinuousAt.continuousWithinAt _;
                exact differentiableAt_riemannZeta ( by aesop ) |> DifferentiableAt.continuousAt;
              exact h_closed.preimage_isClosed_of_isClosed hK.isClosed isClosed_singleton;
            exact hK.of_isClosed_subset h_closed fun x hx => hx.1
          exact h_compact.finite ⟨h_discrete⟩;
        contradiction;
      cases' h_accum_point with z₀ hz₀;
      have := riemannZeta_zeros_isolated z₀ ( by aesop ) hz₀.2.1;
      obtain ⟨ ε, ε_pos, hε ⟩ := this; obtain ⟨ z, hz₁, hz₂, hz₃, hz₄ ⟩ := hz₀.2.2 ε ε_pos; exact hε z hz₃ hz₄ hz₂;

/-
The number of zeros of the Riemann zeta function in the critical strip with imaginary part between 0 and T is finite.
-/
lemma zeta_zeros_finite_in_rect (T : ℝ) :
    (Set.Finite {s : ℂ | riemannZeta s = 0 ∧ 0 < s.re ∧ s.re < 1 ∧ 0 < s.im ∧ s.im ≤ T}) := by
      -- By `riemannZeta_ne_zero_near_one`, � there� exists δ � >� 0 such that `riemannZeta � s� ≠ 0` for all `s ∈ B(1, δ) \ {1}`.
      obtain ⟨δ, hδ_pos, hδ⟩ : ∃ δ > 0, ∀ s : ℂ, s ≠ 1 → s ∈ Metric.ball 1 δ → riemannZeta s ≠ 0 := by
        exact?;
      -- Let $K' = K \setminus B(1, \delta)$. $K'$ is compact because � it� is a closed subset of � the� compact set $K$.
      let K' := Metric.closedBall (Complex.I * (T / 2)) (T / 2 + 1) \ Metric.ball 1 δ;
      -- For any $s \in K'$, $s \neq 1$.
      have hK'_not_one : ∀ s ∈ K', s ≠ 1 := by
        intro s hs; rintro rfl; exact hs.2 <| Metric.mem_ball_self hδ_pos;
      -- By `zeta_zeros_finite_in_compact_avoiding_one`, the set of zeros in $K'$ is finite.
      have hK'_finite : Set.Finite {s ∈ K' | riemannZeta s = 0} := by
        apply zeta_zeros_finite_in_compact_avoiding_one;
        · exact IsCompact.diff ( ProperSpace.isCompact_closedBall _ _ ) ( Metric.isOpen_ball );
        · exact fun h => hK'_not_one 1 h rfl;
      refine' hK'_finite.subset fun s hs => _;
      refine' ⟨ ⟨ _, _ ⟩, hs.1 ⟩ <;> simp_all +decide [ Complex.dist_eq, Complex.normSq, Complex.norm_def ];
      · rw [ Real.sqrt_le_left ] <;> nlinarith [ hs.2.1, hs.2.2.1, hs.2.2.2.1, hs.2.2.2.2 ];
      · exact le_of_not_gt fun h => hδ s ( by rintro rfl; exact absurd hs.2.2.1 ( by norm_num ) ) h hs.1

/-
For any T, there exists a small epsilon such that all zeros of the Riemann zeta function in the critical strip up to height T are contained in the rectangle [epsilon, 1-epsilon] x [0, T].
-/
lemma zeta_zeros_in_rect_bound (T : ℝ) :
    ∃ ε > 0, ε < 1/2 ∧ ∀ s, riemannZeta s = 0 → 0 < s.re → s.re < 1 → 0 < s.im → s.im ≤ T → ε ≤ s.re ∧ s.re ≤ 1 - ε := by
      -- Let $Z = � \�{s \ �in� \mathbb{C} \mid \zeta(s) = 0 \land 0 < \text{Re}(s) < 1 \land 0 < \text{Im}(s) \le T\}$.
      set Z := {s : ℂ | riemannZeta s = 0 ∧ 0 < s.re ∧ s.re < 1 ∧ 0 < s.im ∧ s.im ≤ T};
      by_cases hZ : Z.Nonempty;
      · -- Let $\epsilon_0 = \min \{ \min(s.re, 1-s.re) \mid s \in Z \}$.
        obtain ⟨ε₀, hε₀_pos, hε₀_min⟩ : ∃ ε₀ > 0, ∀ s ∈ Z, ε₀ ≤ s.re ∧ s.re ≤ 1 - ε₀ := by
          -- Since $Z$ is finite, we can choose $\epsilon_0$ to be the minimum of $\min(s.re, 1-s.re)$ over all $s \in Z$.
          obtain ⟨s₀, hs₀⟩ : ∃ s₀ ∈ Z, ∀ s ∈ Z, min s.re (1 - s.re) ≥ min s₀.re (1 - s₀.re) := by
            apply_rules [ Set.exists_min_image ];
            exact?;
          exact ⟨ Min.min s₀.re ( 1 - s₀.re ), lt_min hs₀.1.2.1 ( sub_pos.2 hs₀.1.2.2.1 ), fun s hs => ⟨ by cases min_cases s.re ( 1 - s.re ) <;> cases min_cases s₀.re ( 1 - s₀.re ) <;> linarith [ hs₀.2 s hs ], by cases min_cases s.re ( 1 - s.re ) <;> cases min_cases s₀.re ( 1 - s₀.re ) <;> linarith [ hs₀.2 s hs ] ⟩ ⟩;
        exact ⟨ Min.min ε₀ ( 1 / 4 ), lt_min hε₀_pos ( by norm_num ), by linarith [ min_le_left ε₀ ( 1 / 4 ), min_le_right ε₀ ( 1 / 4 ) ], fun s hs₁ hs₂ hs₃ hs₄ hs₅ => ⟨ by linarith [ hε₀_min s ⟨ hs₁, hs₂, hs₃, hs₄, hs₅ ⟩, min_le_left ε₀ ( 1 / 4 ), min_le_right ε₀ ( 1 / 4 ) ], by linarith [ hε₀_min s ⟨ hs₁, hs₂, hs₃, hs₄, hs₅ ⟩, min_le_left ε₀ ( 1 / 4 ), min_le_right ε₀ ( 1 / 4 ) ] ⟩ ⟩;
      · exact ⟨ 1 / 3, by norm_num, by norm_num, fun s hs hs' hs'' hs''' hs'''' => False.elim <| hZ ⟨ s, hs, hs', hs'', hs''', hs'''' ⟩ ⟩

/-
The number of zeros of the Riemann zeta function in the critical strip with imaginary part between 0 and T, counted with multiplicity.
-/
noncomputable def zetaZeroCountMult (T : ℝ) : ℕ :=
  ∑ s ∈ (zeta_zeros_finite_in_rect T).toFinset, (analyticOrderAt riemannZeta s).toNat
end Aristotle.ZeroCountingV2
