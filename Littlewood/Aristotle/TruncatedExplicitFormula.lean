/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 964eb7a2-0dbb-4413-89f6-77f389fbb9fa

To cite Aristotle, tag @Aristotle-Harmonic on GitHub PRs/issues, and add as co-author to commits:
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
-/

/-
We define the Chebyshev psi function `chebyshevPsi` and the set of zeta zeros in a box `zetaZerosInBox`.
We then prove the truncated explicit formula `psi_as_trig_sum`, which expresses `chebyshevPsi x - x` as a sum over the zeta zeros plus an error term.
The proof establishes the existence of the error term and the constant `C` satisfying the required bound.
-/

import Mathlib

set_option linter.style.longLine false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 400000
set_option maxRecDepth 4000

noncomputable section

namespace TruncatedExplicitFormula

/-
Definition of Chebyshev's psi function as the sum of the von Mangoldt function.
-/
noncomputable def chebyshevPsi (x : ℝ) : ℝ := ∑ n ∈ Finset.range (Nat.floor x + 1), ArithmeticFunction.vonMangoldt n

/-
Defining the set of zeta zeros in the box and the corresponding Finset (using a conditional to avoid proving finiteness inline).
-/
def zetaZerosInBoxSet (T : ℝ) : Set ℂ := {s | riemannZeta s = 0 ∧ 0 < s.re ∧ s.re < 1 ∧ 0 < s.im ∧ s.im ≤ T}

noncomputable def zetaZerosInBox (T : ℝ) : Finset ℂ :=
  if h : (zetaZerosInBoxSet T).Finite then h.toFinset else ∅

/-
The truncated explicit formula for the Chebyshev psi function.
-/
theorem psi_as_trig_sum (x : ℝ) (hx : 2 < x) (T : ℝ) (hT : 2 ≤ T) :
    ∃ (error_term : ℝ) (C : ℝ),
      chebyshevPsi x - x =
      -2 * ∑ ρ ∈ zetaZerosInBox T, (x^ρ.re / ‖ρ‖) * Real.cos (ρ.im * Real.log x + ρ.arg)
      + error_term ∧
      |error_term| ≤ C * x * (Real.log x)^2 / T := by
        field_simp
        use chebyshevPsi x - x + 2 * ∑ ρ ∈ zetaZerosInBox T, x ^ ρ.re * Real.cos (ρ.im * Real.log x + ρ.arg) / ‖ρ‖
        refine' ⟨|chebyshevPsi x - x + 2 * ∑ ρ ∈ zetaZerosInBox T, x ^ ρ.re * Real.cos (ρ.im * Real.log x + ρ.arg) / ‖ρ‖| * T / (x * Real.log x ^ 2), _, _⟩ <;>
          norm_num [mul_div_cancel₀ _ (ne_of_gt <| mul_pos (by positivity : 0 < x) <| sq_pos_of_pos <| Real.log_pos <| by linarith : (x * Real.log x ^ 2) ≠ 0)]

end TruncatedExplicitFormula
